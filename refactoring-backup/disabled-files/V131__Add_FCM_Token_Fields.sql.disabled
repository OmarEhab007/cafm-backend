--
-- Add FCM token fields to users table for push notifications
-- Migration V131: Add FCM Token Fields
-- Author: Claude Code Assistant
-- Date: 2024-01-01
--

-- Add FCM token fields for push notifications
ALTER TABLE users ADD COLUMN IF NOT EXISTS fcm_token VARCHAR(500);
ALTER TABLE users ADD COLUMN IF NOT EXISTS fcm_token_updated_at TIMESTAMP;

-- Add index on fcm_token for efficient lookups
CREATE INDEX IF NOT EXISTS idx_users_fcm_token ON users(fcm_token) WHERE fcm_token IS NOT NULL;

-- Add comment to document the purpose
COMMENT ON COLUMN users.fcm_token IS 'Firebase Cloud Messaging token for push notifications';
COMMENT ON COLUMN users.fcm_token_updated_at IS 'Timestamp when the FCM token was last updated';

-- Update existing users with null values (already done by default, but for clarity)
-- Temporarily disable history trigger to avoid version conflicts
ALTER TABLE users DISABLE TRIGGER history_trigger_users;
UPDATE users SET fcm_token = NULL, fcm_token_updated_at = NULL WHERE fcm_token IS NULL;
ALTER TABLE users ENABLE TRIGGER history_trigger_users;